import sys
import os
import shlex
import subprocess
import webbrowser

# This saves the default path of nmap/scripts, where Vulscan needs to be installed
paths = {'win32': 'C:\\Program Files\\Nmap\\scripts\\',
         'darwin': '/usr/local/share/nmap/scripts/',
         'linux': '/usr/share/nmap/scripts/'}

os_name = sys.platform

# Check whether nmap is installed or not
def check_nmap_exist():
    if os_name == 'win32':
        shell_cmd = 'where nmap'

    else:
        shell_cmd = 'which nmap'

    proc = subprocess.Popen(shlex.split(shell_cmd), stdout=subprocess.PIPE)

    try:
        output, errors = proc.communicate(timeout=10)
    except Exception as e:
        print(e)
        proc.kill()

    return os.path.exists(output.decode('utf8').strip()), output.decode('utf-8').strip()

# Searches for the nmap/script folder, it tries to find it in the parent folder of nmap binary, then the parent of
# the parent all the way up to /

def search_for_script_folder(nmap_path):
    search_path = os.path.dirname(nmap_path)
    result = []
    for dirpath, dirname, filename in os.walk(search_path):
        if 'nmap/scripts' in dirpath:
            result.append(dirpath)
    if result:
        return result

    else:
        return search_for_script_folder(search_path)


if __name__ == '__main__':
    e, nmap_path = check_nmap_exist()
    if e:  # nmap is installed
        if os.path.exists(paths[os_name]): # try to install Vulscan in default script path
            cmd = 'cd ' + paths[os_name] + ' && git clone https://github.com/vulnersCom/nmap-vulners.git'
            proc = subprocess.run(cmd, shell=True, capture_output=True)
            if proc.stderr:
                print(proc.stderr)
                sys.exit(-1)
            else:
                print(proc.stdout)
                print('Installation successfully completed')
                print('exiting.......')
                sys.exit(0)
        else:    # Nmap/script folder is on some other path, finds it and install Vulscan
            script_path = search_for_script_folder(nmap_path)
            cmd = 'cd ' + script_path[0] + ' && git clone https://github.com/vulnersCom/nmap-vulners.git'
            proc = subprocess.run(cmd, shell=True, capture_output=True)
            if proc.stderr:
                print(proc.stderr)
                sys.exit(-1)
            else:
                print(proc.stdout)
                print('Installation successfully completed')
                print('exiting.......')
                sys.exit(0)


    else: # When nmap is not installed
        if os_name in ['win32', 'darwin']:
            print('Please follow the installation webpage to install nmap')
            webbrowser.open('https://nmap.org/download.html')
            sys.exit(-1)

        else:
            print('Please install nmap with sudo apt-get install nmap')
            sys.exit(-1)
